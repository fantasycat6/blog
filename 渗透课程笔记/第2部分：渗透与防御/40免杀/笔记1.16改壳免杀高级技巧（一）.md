## 免杀壳世界高级基础（一）

* **传统壳基础方式：**

1.壳的分类：压缩壳和加密壳
2.壳的作用：保护和文件免杀
二.加壳免杀的几个弱点
1.不能躲过像瑞星这类具有内存查杀功能的杀毒软件。
2.一般不能躲过卡巴的查杀
因为卡巴采用了一种叫虚拟机技术。首先把加了多层壳的*程序在虚拟机环境下运行一下**，**这样*程序就会现出本来面目，这样无论你加了多少层壳，在运行后程序还是要暴露自已的。所以大家在加壳测试过程中也会发现，能过其它的多种杀毒软件，但卡巴始终很难过，其原因就是卡巴的虚拟技术在作怪。
三.是不是现在的加壳免杀已失去意义
每种免杀技术都有他的缺点和优点，比如加壳，首先要找到比较生僻的壳,而且可能以后很快被查杀.同时也不能过内存查杀,也很难过卡巴.但它操作方便,通用性好加一个壳,可能过好几个杀毒软件.又比如修改特征码.首先操作比较烦,要定位,要修改,改好后还要测试是否能正常使用.同时针对性非常强.只能针对某一种杀毒软件的免杀,各种杀毒软件的特征码都不一样,所以要躲过多种杀毒软件查杀,就要分别定位,修改每种杀毒软件的特征码.这样是相当麻烦的.但它可以通过修改特征码来躲过瑞星内存和卡巴的查杀.
所以以后免杀技术会把加壳,加花指令,改入口点,改特征码这几种方法结合起来使用.对付瑞星的内存查杀,我们可以修改内存特征码,对付卡巴的虚拟机技术.我们可以修改卡巴的特征码.在加上加冷门壳,加花指令,改入口点.综合这些方法就可以打造金钢不死之身!
四.加壳免杀实例演示部分:
1.加生僻壳免杀:实例演示
2.加伪装壳免杀:实例演示
3.多重加壳免杀:（用MM彩衣进行多重加壳）

* **现今免杀壳的高级基础方式：**

## 1.1   基础知识

1、编程语言：C/C++、ASM、Shellcode编程；

2、PE相关：熟悉PE结构（PE头、区段、IAT表、重定位表）；

3、其他： PE加载原理。

## 1.2   免杀方法

Ø  针对传统的特征码匹配引擎、启发式引擎，常用的免杀方式如下：

²  特征码免杀法：最基本的免杀技术，不解释

²  通用免杀法：替换资源、增加签名、加冷门壳、加多重壳

²  源码免杀法：当前主流免杀技术，需要有源代码才能操作。通过修改病毒的特征字符串、动态API调用、修改编译环境、套程序外壳(MFC、SDK、QT)等

²  输入表(IAT)免杀法：启发式引擎会扫描目标程序的输入表中是否包含指定的函数特征序列(函数调用特征码)。

解决方案：(本段摘自未知作者)

1、 输入表函数移位法：输入这是最早也是比较简单的输人表免杀方法了，虽然效果已经不像当年那么好了，但却是学习免杀过程必须要掌握的基础知识。我们使用C32打开一个EXE文件，找到输入表段，找到我们定位出的特征输入表，比如ShellExecuteA就是，我们将其使用OO填充，然后在附近找到一片空白区域，将刚才找到的代码再粘贴到空白区域中，并记下新函数的地址，ShellExecuteA字符串最前面的那个“S”的地址减2，即00078925，这样就实现了转移，但是要想让程序知道我们转移的函数，我们还得告诉输入表，刚才那个地址是文件偏移地址，但不是内存地址，我们需要利用OC计算出新的输入表函数ShellExecuteA的内存位置，并在LoadPE中修改才行。

2、 输入表函数对调法：这个方法的原理就是将输入表函数名长度相同的函数在C32中进行对调，只有长度一样才不会出错，然后在LoadPE中做相应的修改即可。比如被查杀的函数是OpenFileA，存在于A.dll文件中，我们在b.dll中找到了一个GetATimeA函数，这两个函数名称长度一样，我们在C32中做了静态对换之后，还要将它们的RVA进行对换，操作很简单的，我就不演示了。

3、 手工重建输入表：关于输入表的重建，我想大家都非常熟悉了吧，这算是比较复杂的一种方法了，不过免杀效果非常好，这也是必须要掌握的方法哦！这个方法其实就是添加一个新区段，再把原来的输入表移到我们新建的区段上，重建主要是针对杀毒软件定位到大片输入表函数。

4、 输入表隐藏法：将输入表加密隐藏，然后内存解密修复输入表。属于保护壳常用的技术。

²  代码混淆、加花：通过对特征代码进行膨胀、乱序来干扰启发式引擎的分析，以及提升人工提取特征码的难度。

²  入口点模糊技术：参考"主要技术"目录下的"入口点模糊技术"

²  内存加载执行PE文件：壳的基本技术，论坛资料很多。

Ø  机器学习引擎（以360QVM为例），绕过方式如下：

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2446/1652709234084/fa26ae46054a45fd85970c6552b3f591.png)

## 免杀壳主动防御基础（二）

Ø  主动防御：

```
 简介：主动防御是基于程序行为自主分析判断的实时防护技术，不以病毒的特征码作为判断病毒的依据，而是从最原始的病毒定义出发，直接将程序的行为作为判断病毒的依据。

 360主动防御模块经过做黑灰兄弟们的不懈努力，已经非常完善了，绝大部分常规、非常规的行为绕过方式均已被拦截，并弹出一个默认阻止的小框框。
```

1、继续挖掘非常规方法绕过主防的拦截，主防未监控到的区域。

2、白程序(包含在杀软白名单库中的程序)加黑程序方式来执行高危行为，写启动项、键盘记录等。(不过要注意的是360白程序判定逻辑，灰程序加载的白程序 = 灰程序，因此需要绕过主防的程序执行链监控)

## 红队实战-改壳免杀（三）

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2446/1652709234084/254a1984157647f99c006c984928933e.png)

改壳之前：

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2446/1652709234084/c469aa1e71ce41d895b857f952b64851.png)

```
改壳之前的代码：
0042916C >  9C              pushfd
0042916D    60              pushad
0042916E    E8 00000000     call dan.00429173
00429173    5D              pop ebp                                  ; kernel32.7C817077
00429174    83ED 07         sub ebp,0x7
00429177    8D8D 10FFFFFF   lea ecx,dword ptr ss:[ebp-0xF0]
0042917D    8039 01         cmp byte ptr ds:[ecx],0x1
00429180    0F84 42020000   je dan.004293C8
00429186    C601 01         mov byte ptr ds:[ecx],0x1
00429189    8BC5            mov eax,ebp
0042918B    2B85 A4FEFFFF   sub eax,dword ptr ss:[ebp-0x15C]
00429191    8985 A4FEFFFF   mov dword ptr ss:[ebp-0x15C],eax
00429197    0185 D4FEFFFF   add dword ptr ss:[ebp-0x12C],eax
0042919D    8DB5 18FFFFFF   lea esi,dword ptr ss:[ebp-0xE8]
004291A3    0106            add dword ptr ds:[esi],eax
004291A5    55              push ebp
004291A6    56              push esi
004291A7    6A 40           push 0x40
004291A9    68 00100000     push 0x1000


```

改壳之后：

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2446/1652709234084/567705828048484ab5082275fa1800a8.png)

```
改壳之后：

00440000 >  60              pushad
00440001    33C0            xor eax,eax
00440003    33DB            xor ebx,ebx
00440005    61              popad
00440006  - E9 6191FEFF     jmp 改壳后.0042916C
0044000B    90              nop
0044000C    0000            add byte ptr ds:[eax],al
0044000E    0000            add byte ptr ds:[eax],al
00440010    6c              ins byte ptr es:[edi],dx
00440011    91              xchg eax,ecx
00440012    0200            add al,byte ptr ds:[eax]
00440014    0000            add byte ptr ds:[eax],al
00440016    0000            add byte ptr ds:[eax],al


```

## 红队实战-改壳免杀之签名克隆（四）

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2446/1652709234084/cb3c0877f9d6403692ecb44e07231f8e.png)

![image.png](https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2446/1652709234084/442ab113dfc040fc82610accf4cc2c5d.png)
